# Weather Dataset Visualizer

A comprehensive data visualization pipeline for analyzing weather-classified image datasets generated by SWIFT.

## Overview

The Weather Dataset Visualizer processes subdirectories containing weather-classified images and generates:
- Detailed statistics and CSV tables
- Visual plots and charts
- Comparison analyses across multiple datasets

## Usage

### Command Line

```bash
python scripts/visualization/weather_dataset_visualizer.py /path/to/datasets
```

### Python API

```python
from scripts.visualization.weather_dataset_visualizer import WeatherDatasetVisualizer

visualizer = WeatherDatasetVisualizer('/path/to/datasets')
visualizer.analyze_all_datasets()
visualizer.generate_all_visualizations()
```

## Generated Outputs

### CSV Tables

| File | Description |
|------|-------------|
| `category_distribution.csv` | Raw count of images per category per dataset |
| `category_percentages.csv` | Percentage distribution per category per dataset |
| `dataset_balance_metrics.csv` | Imbalance Ratio (IR) and Normalized Shannon Entropy (H_norm) |
| `confidence_statistics.csv` | Classification confidence statistics |
| `fog_analysis.csv` | Fog detection metrics |
| `outdoor_confidence.csv` | Outdoor classification confidence |
| `*_category_score_matrix.csv` | Per-dataset category confusion scores |
| `*_confusion_analysis.csv` | Per-dataset classification confusion analysis |

### Visualization Plots

| File | Description |
|------|-------------|
| `category_distribution_bars.png` | Grouped bar chart of category counts |
| `category_distribution_stacked.png` | Stacked percentage distribution |
| `category_pie_charts.png` | Pie charts per dataset |
| `balance_metrics.png` | Dataset balance analysis (IR, H_norm, coverage) |
| `confidence_distributions.png` | Confidence score distributions |
| `margin_analysis.png` | Classification margin analysis |
| `fog_analysis.png` | Fog detection analysis |
| `outdoor_confidence_analysis.png` | Outdoor confidence analysis |
| `dataset_comparison_summary.png` | Multi-metric comparison |
| `*_score_heatmap.png` | Per-dataset category score heatmaps |

## Dataset Balance Metrics

The visualizer computes two key metrics to quantify dataset balance:

### Imbalance Ratio (IR)

Quantifies how much the largest domain outnumbers the smallest one.

**Formula:** `IR = N_max / N_min`

Where:
- `N_max` = count of the largest weather category
- `N_min` = count of the smallest weather category

**Interpretation:**
| IR Value | Meaning |
|----------|---------|
| IR = 1 | Perfectly balanced (all categories have equal counts) |
| IR > 1 | Some categories are rarer than others |
| IR = ∞ | At least one category has zero samples |

**Example:**
```
Category counts: {clear_day: 1000, foggy: 100, ...}
IR = 1000 / 100 = 10.0  # clear_day is 10x more frequent than foggy
```

### Normalized Shannon Entropy (H_norm)

Measures how close the domain distribution is to uniform on a 0–1 scale.

**Formula:** 
```
H = -Σ p_i * log(p_i)    # Shannon entropy (ignoring p_i = 0)
H_max = log(K)            # Maximum entropy for K categories
H_norm = H / H_max        # Normalized entropy
```

Where:
- `p_i = count_i / total` = probability of category i
- `K = 7` = number of weather categories

**Interpretation:**
| H_norm Value | Meaning |
|--------------|---------|
| H_norm = 1.0 | Perfectly uniform distribution (all categories equally frequent) |
| H_norm → 0 | Highly skewed distribution (one category dominates) |
| H_norm = NaN | Empty dataset or K ≤ 1 |

**Example:**
```
Uniform: {each category: 100} → H_norm = 1.0
Skewed:  {clear_day: 1000, others: 0} → H_norm = 0.0
Partial: {2 categories with 500 each, 5 empty} → H_norm = log(2)/log(7) ≈ 0.356
```

### Relationship Between IR and H_norm

| Scenario | IR | H_norm | Description |
|----------|-----|--------|-------------|
| Perfect balance | 1.0 | 1.0 | All 7 categories have equal counts |
| Missing categories | ∞ | < 1 | Some categories have zero samples |
| Moderate imbalance | > 1 | 0.5-0.9 | All categories present but unequal |
| Extreme imbalance | ∞ | → 0 | One category dominates, others empty |

### Visualization

The `balance_metrics.png` plot includes:
1. **Imbalance Ratio bar chart** - Red bars indicate IR=∞ (missing categories)
2. **Normalized Shannon Entropy bar chart** - Higher values = more balanced
3. **IR vs H_norm scatter plot** - Ideal position is lower-left (low IR, high H_norm)
4. **Category coverage chart** - Shows how many of the 7 categories have data

## Expected Directory Structure

The visualizer expects datasets organized as:

```
parent_folder/
├── Dataset1/
│   └── images/  (or categories/ or categories/original_size/)
│       ├── clear_day/
│       │   ├── image_001.jpg
│       │   └── image_001.json
│       ├── cloudy/
│       ├── rainy/
│       ├── snowy/
│       ├── foggy/
│       ├── night/
│       └── dawn_dusk/
├── Dataset2/
│   └── ...
└── analysis_output/  (generated)
    ├── *.csv
    └── plots/
        └── *.png
```

## Weather Categories

The visualizer analyzes the 7 standard weather categories:

| Category | Display Name |
|----------|--------------|
| `clear_day` | Clear Day |
| `cloudy` | Cloudy |
| `dawn_dusk` | Dawn/Dusk |
| `foggy` | Foggy |
| `night` | Night |
| `rainy` | Rainy |
| `snowy` | Snowy |

## Requirements

```
matplotlib>=3.5.0
seaborn>=0.11.0
pandas>=1.3.0
numpy>=1.20.0
```

## Example Output

Running on a sample dataset collection:

```
$ python weather_dataset_visualizer.py /path/to/AWARE

Discovered 9 datasets: ['IDD-AW', 'Cityscapes', 'BDD100k', ...]

Dataset Balance Metrics:
┌──────────────────┬───────────┬────────┬────────┐
│ Dataset          │ IR        │ H_norm │ Cats   │
├──────────────────┼───────────┼────────┼────────┤
│ ACDC             │ 37.11     │ 0.904  │ 7/7    │
│ IDD-AW           │ 6.34      │ 0.891  │ 7/7    │
│ AWACS            │ ∞         │ 0.921  │ 6/7    │
│ Cityscapes       │ ∞         │ 0.387  │ 4/7    │
│ IDD              │ ∞         │ 0.177  │ 3/7    │
└──────────────────┴───────────┴────────┴────────┘

Best balanced: ACDC (all categories, H_norm=0.90)
Most imbalanced: IDD (only 3 categories, H_norm=0.18)
```

## Testing

Run the balance metrics unit tests:

```bash
python scripts/visualization/test_balance_metrics.py
```

Tests cover:
- Perfectly balanced datasets (IR=1, H_norm=1)
- Imbalanced datasets with various ratios
- Datasets with missing categories (IR=∞)
- Edge cases (empty datasets, single category)
